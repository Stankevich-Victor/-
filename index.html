<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Поточний розклад</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .active-tab {
      background-color: #e0e7ff;
      color: #3b82f6;
    }
    textarea {
      resize: vertical;
      min-height: 48px;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-slate-50 text-slate-900 p-6">
  <div class="max-w-3xl mx-auto">
    <header class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold">Розклад занять</h1>
        <div id="date-info" class="mt-1 text-sm text-gray-600"></div>
      </div>
    </header>

    <nav class="flex space-x-2 mb-6 p-1 bg-gray-100 rounded-xl shadow-inner">
        <a href="rozdklad.html" class="flex-1 py-2 px-4 rounded-lg text-center font-medium transition-colors">Розклад уроків</a>
        <a href="index.html" class="flex-1 py-2 px-4 rounded-lg text-center font-medium transition-colors active-tab">Поточний розклад</a>
        <a href="DZ.html" class="flex-1 py-2 px-4 rounded-lg text-center font-medium transition-colors">Домашнє завдання</a>
    </nav>
    
    <div id="status-message" class="mb-4"></div>
    <section class="space-y-3">
      <h2 id="current-day-name" class="text-xl font-semibold mb-2"></h2>
      <div id="schedule-list" class="grid gap-3"></div>
    </section>
    <div class="my-8 h-px bg-gray-200"></div>
    <section class="mt-8 space-y-3">
      <h2 id="tomorrow-day-name" class="text-xl font-semibold mb-2"></h2>
      <div id="tomorrow-schedule-list" class="grid gap-3"></div>
    </section>
  </div>

  <script>
    // ====== НАЛАШТУВАННЯ ТА СПІЛЬНІ ФУНКЦІЇ ======
    const TIME_ZONE = "Europe/Kyiv";

    const DAYS = [
      { key: "sunday", name: "Неділя" },
      { key: "monday", name: "Понеділок" },
      { key: "tuesday", name: "Вівторок" },
      { key: "wednesday", name: "Середа" },
      { key: "thursday", name: "Четвер" },
      { key: "friday", name: "Пʼятниця" },
      { key: "saturday", name: "Субота" },
    ];

    const LESSON_TIMES = [
      { start: "08:30", end: "09:50" },
      { start: "10:00", end: "11:20" },
      { start: "11:40", end: "13:00" },
      { start: "13:30", end: "14:50" },
    ];

    const schedule = {
      1: {
        monday: [{ title: "Зарубіжна література", room: "4014" }, { title: "Англійська мова", room: "3011, 4019" }, { title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }],
        tuesday: [{ title: "Фізкультура", room: "Спортзал" }, { title: "Математика", room: "3001" }, { title: "Українська література", room: "3019" }],
        wednesday: [{ title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }, { title: "Історія", room: "3001" }, { title: "Захист України", room: "3016" }],
        thursday: [{ title: "Фізика", room: "227" }, { title: "Хімія", room: "403" }, { title: "Інформатика", room: "3014" }, { title: "Година спілкування", room: "3001" }],
        friday: [{ title: "Фізкультура", room: "Спортзал" }, { title: "Українська мова", room: "3019, 4019" }, { title: "Математика", room: "3014" }, { title: "Інформатика", room: "3003" }],
      },
      2: {
        monday: [{ title: "Англійська мова", room: "3011, 4014" }, { title: "Математика", room: "3014" }, { title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }],
        tuesday: [{ title: "Математика", room: "3014" }, { title: "Географія", room: "3016" }, { title: "Українська література", room: "3019" }],
        wednesday: [{ title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }, { title: "Історія", room: "2001" }, { title: "Інформатика", room: "3016" }, { title: "Захист України", room: "3017" }],
        thursday: [{ title: "Фізика і астрономія", room: "227" }, { title: "Хімія, Історія", room: "4014, 3001" }, { title: "Година спілкування" }],
        friday: [{ title: "Фізкультура", room: "Спортзал" }, { title: "Українська мова", room: "3019, 4019" }, { title: "Математика", room: "3014" }, { title: "Англійська мова", room: "3001" }],
      },
      3: {
        monday: [{ title: "Зарубіжна література", room: "4014" }, { title: "Англійська мова", room: "3011, 3016" }, { title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }],
        tuesday: [{ title: "Фізкультура", room: "Спортзал" }, { title: "Математика", room: "3014" }, { title: "Українська література", room: "3019" }],
        wednesday: [{ title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }, { title: "Історія", room: "3001" }, { title: "Захист України", room: "3016" }, { title: "Інформатика", room: "3003" }],
        thursday: [{ title: "Фізика і астрономія", room: "227" }, { title: "Хімія", room: "403" }, { title: "Математика", room: "3016" }, { title: "Година спілкування", room: "3001" }],
        friday: [{ title: "Фізкультура", room: "Спортзал" }, { title: "Українська мова", room: "3019, 4019" }, { title: "Інформатика", room: "3014" }],
      },
      4: {
        monday: [{ title: "Англійська мова", room: "3018, 4014" }, { title: "Математика", room: "3014" }, { title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }],
        tuesday: [{ title: "Математика", room: "3014" }, { title: "Географія", room: "3016" }, { title: "Українська література", room: "3019" }, { title: "Година спілкування", room: "3014" }],
        wednesday: [{ title: "Профільні предмети (Фізика/Біологія)", room: "403а, 227" }, { title: "Історія", room: "2001" }, { title: "Захист України", room: "3016" }],
        thursday: [{ title: "Фізика і астрономія", room: "227" }, { title: "Хімія", room: "4014" }, { title: "Англійська мова", room: "3001" }],
        friday: [{ title: "Фізкультура", room: "Спортзал" }, { title: "Українська мова", room: "4019, 3019" }, { title: "Інформатика", room: "3014" }],
      },
    };

    function getIsoWeek(date) {
        const d = new Date(date.getTime());
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
        const week1 = new Date(d.getFullYear(), 0, 4);
        return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }

    function getDateInTZ(tz, offsetDays = 0) {
        const now = new Date();
        now.setDate(now.getDate() + offsetDays);
        const fmt = new Intl.DateTimeFormat("en-CA", {
            timeZone: tz,
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
        });
        const parts = fmt.formatToParts(now);
        const get = (t) => parts.find((p) => p.type === t)?.value;
        const y = Number(get("year"));
        const m = Number(get("month"));
        const d = Number(get("day"));
        return new Date(y, m - 1, d);
    }

    function parseTimeToMinutes(t) {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
    }

    function isNowBetween(start, end) {
        const now = new Date();
        const options = {
            timeZone: TIME_ZONE,
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
        };
        const formatter = new Intl.DateTimeFormat("en-US", options);
        const parts = formatter.formatToParts(now);
        const hourPart = parts.find((p) => p.type === "hour");
        const minutePart = parts.find((p) => p.type === "minute");
        const hh = Number(hourPart?.value);
        const mm = Number(minutePart?.value);

        const cur = hh * 60 + mm;
        return cur >= parseTimeToMinutes(start) && cur < parseTimeToMinutes(end);
    }

    function getCurrentStatus(dayKey, weekType) {
        const currentDaySchedule = schedule[weekType]?.[dayKey];
        if (!currentDaySchedule || currentDaySchedule.length === 0) {
            return { status: "empty" };
        }

        const currentMinute = parseTimeToMinutes(
            new Intl.DateTimeFormat("en-US", { timeZone: TIME_ZONE, hour: "2-digit", minute: "2-digit", hour12: false }).format(new Date())
        );

        for (let i = 0; i < LESSON_TIMES.length; i++) {
            const lesson = LESSON_TIMES[i];
            const lessonStart = parseTimeToMinutes(lesson.start);
            const lessonEnd = parseTimeToMinutes(lesson.end);

            if (currentMinute >= lessonStart && currentMinute < lessonEnd) {
                const minutesLeft = lessonEnd - currentMinute;
                return {
                    status: "lesson",
                    title: currentDaySchedule[i]?.title,
                    minutesLeft: minutesLeft
                };
            }
        }

        for (let i = 0; i < LESSON_TIMES.length - 1; i++) {
            const breakStart = parseTimeToMinutes(LESSON_TIMES[i].end);
            const breakEnd = parseTimeToMinutes(LESSON_TIMES[i + 1].start);
            if (currentMinute >= breakStart && currentMinute < breakEnd) {
                const minutesLeft = breakEnd - currentMinute;
                return {
                    status: "break",
                    minutesLeft: minutesLeft
                };
            }
        }

        const firstLessonStart = parseTimeToMinutes(LESSON_TIMES[0].start);
        if (currentMinute < firstLessonStart) {
            const minutesToStart = firstLessonStart - currentMinute;
            return {
                status: "before",
                minutesToStart: minutesToStart
            };
        }

        const lastLessonEnd = parseTimeToMinutes(LESSON_TIMES[LESSON_TIMES.length - 1].end);
        if (currentMinute >= lastLessonEnd) {
            return { status: "after" };
        }

        return { status: "unknown" };
    }

    function renderDailySchedule(date, containerId, dayNameContainerId) {
        const isoWeek = getIsoWeek(date);
        const weekNum = (isoWeek % 4 === 0) ? 4 : isoWeek % 4;
        const jsDay = date.getDay();
        const dayKey = DAYS[jsDay].key;
        
        const dayNameElem = document.getElementById(dayNameContainerId);
        if (dayNameElem) dayNameElem.textContent = DAYS[jsDay].name;

        const items = schedule[weekNum]?.[dayKey] || [];
        const scheduleList = document.getElementById(containerId);
        scheduleList.innerHTML = '';

        if (items.length === 0) {
            scheduleList.innerHTML = `<div class="p-6 rounded-2xl border border-dashed text-center text-gray-600">На цей день розклад порожній.</div>`;
        } else {
            items.forEach((item, index) => {
                const { start, end } = LESSON_TIMES[index] || {};
                const activeLesson = containerId === "schedule-list" && start && end && isNowBetween(start, end);
                
                const noteKey = `note-${item.title.replace(/\s/g, '-')}-${item.room ? item.room.replace(/\s/g, '-') : ''}`;
                const savedNote = localStorage.getItem(noteKey) || '';

                const itemHtml = `
                    <div class="flex items-center justify-between p-3 rounded-2xl border shadow-sm ${activeLesson ? "active" : "border-gray-200"}">
                        <div>
                            <div class="font-semibold">${index + 1} пара: ${item.title}</div>
                            ${item.room ? `<div class="text-sm text-gray-600">${item.room}</div>` : ""}
                        </div>
                        ${start && end ? `<div class="tabular-nums font-medium">${start}–${end}</div>` : ""}
                    </div>
                    ${(containerId === 'tomorrow-schedule-list' || savedNote) ? `
                    <div class="p-3">
                        <textarea class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all"
                            placeholder="Напишіть нотатку для цього предмета..."
                            id="${noteKey}"
                            ${containerId === 'tomorrow-schedule-list' ? `oninput="saveNote('${noteKey}')"` : 'readonly'}
                        >${savedNote}</textarea>
                    </div>
                    ` : ''}
                `;
                scheduleList.insertAdjacentHTML("beforeend", itemHtml);

                if (index < items.length - 1) {
                    const breakEnd = LESSON_TIMES[index + 1]?.start;
                    const activeBreak = containerId === "schedule-list" && start && breakEnd && isNowBetween(end, breakEnd);
                    const breakDuration = breakEnd ? parseTimeToMinutes(breakEnd) - parseTimeToMinutes(end) : null;
                    const breakHtml = `
                        <div class="p-3 rounded-2xl border border-dashed text-center text-gray-600 ${activeBreak ? "active" : ""}">
                            Перерва${breakDuration ? ` (${breakDuration} хв)` : ''}
                        </div>
                    `;
                    scheduleList.insertAdjacentHTML("beforeend", breakHtml);
                }
            });
        }
    }

    function saveNote(noteKey) {
        const textarea = document.getElementById(noteKey);
        localStorage.setItem(noteKey, textarea.value);
    }

    function renderStatus(dayKey, weekType) {
        const currentStatus = getCurrentStatus(dayKey, weekType);
        const statusElement = document.getElementById("status-message");
        let statusHtml = '';
        switch (currentStatus.status) {
            case "lesson":
                statusHtml = `<div class="bg-indigo-50 border border-indigo-200 text-indigo-800 p-4 rounded-xl text-center mb-4"><span class="font-semibold">${currentStatus.title}</span>: залишилося ${currentStatus.minutesLeft} хв.</div>`;
                break;
            case "break":
                statusHtml = `<div class="bg-green-50 border border-green-200 text-green-800 p-4 rounded-xl text-center mb-4">Перерва: залишилося ${currentStatus.minutesLeft} хв.</div>`;
                break;
            case "before":
                statusHtml = `<div class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-xl text-center mb-4">До початку першої пари: ${currentStatus.minutesToStart} хв.</div>`;
                break;
            case "after":
                statusHtml = `<div class="bg-gray-50 border border-gray-200 text-gray-800 p-4 rounded-xl text-center mb-4">Сьогоднішні заняття закінчилися.</div>`;
                break;
            case "empty":
                statusHtml = `<div class="p-6 rounded-2xl border border-dashed text-center text-gray-600">На цей день розклад порожній.</div>`;
                break;
        }
        statusElement.innerHTML = statusHtml;
    }
    
    // ====== ЛОГІКА ДЛЯ ЦІЄЇ СТОРІНКИ ======
    document.addEventListener("DOMContentLoaded", () => {
        const todayTZ = getDateInTZ(TIME_ZONE);
        const isoWeek = getIsoWeek(todayTZ);
        const weekNum = (isoWeek % 4 === 0) ? 4 : isoWeek % 4;
        const jsDay = todayTZ.getDay();
        const dayKey = DAYS[jsDay].key;
        
        document.getElementById("date-info").textContent = `${new Intl.DateTimeFormat("uk-UA", { timeZone: TIME_ZONE, dateStyle: "full" }).format(new Date())} — ${weekNum}-й тиждень`;
        renderStatus(dayKey, weekNum);
        renderDailySchedule(todayTZ, "schedule-list", "current-day-name");

        const tomorrowTZ = getDateInTZ(TIME_ZONE, 1);
        renderDailySchedule(tomorrowTZ, "tomorrow-schedule-list", "tomorrow-day-name");
    });
  </script>
</body>
</html>